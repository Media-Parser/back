## ğŸ’¬ Node: `chat_history_node.py`

ì´ ëª¨ë“ˆì€ LangGraph ê¸°ë°˜ ëŒ€í™” ì‹œìŠ¤í…œì—ì„œ **ì´ì „ ëŒ€í™” ê¸°ë¡ì„ ìš”ì•½í•˜ê±°ë‚˜ ì €ì¥**í•˜ëŠ” ë° ì‚¬ìš©ë˜ëŠ” ë…¸ë“œì…ë‹ˆë‹¤.  
ëŒ€í™” íë¦„ì„ ë” ì •í™•í•˜ê²Œ ìœ ì§€í•˜ê³ , ë¬¸ë§¥ ê¸°ë°˜ ì‘ë‹µ ìƒì„±ì„ ì§€ì›í•©ë‹ˆë‹¤.

---

### 1ï¸âƒ£ `load_context_node`

#### âœ… ì—­í• 
ì‚¬ìš©ìì˜ í˜„ì¬ ì§ˆë¬¸ì— ëŒ€í•´, ì´ì „ ëŒ€í™” ê¸°ë¡ ì¤‘ **ê´€ë ¨ ìˆëŠ” ë¶€ë¶„ë§Œ ìš”ì•½**í•˜ì—¬ contextë¡œ ì œê³µí•©ë‹ˆë‹¤.

#### âš™ï¸ ì²˜ë¦¬ ë°©ì‹
- `doc_id` ê¸°ì¤€ ìµœê·¼ ì§ˆë¬¸/ì‘ë‹µ 5ê°œë¥¼ MongoDBì—ì„œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
- `Q: ... / A: ...` í˜•ì‹ìœ¼ë¡œ ì •ë¦¬ í›„, LLMì—ê²Œ ì „ë‹¬í•˜ì—¬ ìš”ì•½í•©ë‹ˆë‹¤.
- LLMì€ í˜„ì¬ ì§ˆë¬¸ê³¼ **ì§ì ‘ ê´€ë ¨ëœ ì •ë³´ë§Œ** ìš”ì•½í•˜ì—¬ ë°˜í™˜í•©ë‹ˆë‹¤.

#### ğŸ“¥ ì…ë ¥ ì˜ˆì‹œ (`state`)
```json
{
  "doc_id": "doc_123",
  "question": "ì´ì „ì— ì–´ë–¤ ì •ì±…ì„ ì¶”ì²œí–ˆì—ˆì§€?"
}
````

#### ğŸ“¤ ì¶œë ¥ ì˜ˆì‹œ (`state["context"]`)

```json
{
  "context": "ì´ì „ì— ë°ì´í„° 3ë²• ê´€ë ¨ ì •ì±…ì´ ì¶”ì²œë˜ì—ˆìŠµë‹ˆë‹¤."
}
```

---

### 2ï¸âƒ£ `save_chathistory_node`

#### âœ… ì—­í• 

ì‚¬ìš©ìì˜ ì§ˆë¬¸, ìƒì„±ëœ ì‘ë‹µ, ì ìš© ì •ë³´ ë“±ì„ **MongoDBì— ì €ì¥**í•˜ì—¬ ëŒ€í™” íˆìŠ¤í† ë¦¬ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.

#### ğŸ›  ì €ì¥ í•­ëª© ì˜ˆì‹œ

| í•„ë“œ                          | ì„¤ëª…             |
| --------------------------- | -------------- |
| `doc_id`                    | ì„¸ì…˜/ë¬¸ì„œ ê³ ìœ  ID    |
| `question`                  | ì‚¬ìš©ì ì§ˆë¬¸         |
| `generation`                | ìƒì„±ëœ ì‘ë‹µ         |
| `selected_text`             | ì„ íƒëœ ë¬¸ì¥ (ì„ íƒì )   |
| `suggestion`                | ì¶”ì²œ ë¬¸ì¥ (ì„ íƒì )    |
| `apply_title`, `apply_body` | ì‹¤ì œ ì ìš© ì—¬ë¶€ (ì„ íƒì ) |
| `value_type`                | ì‘ë‹µ ìœ í˜• ë¶„ë¥˜ (ì„ íƒì ) |

> ì €ì¥ì€ ë‚´ë¶€ `chat_service.py`ì˜ `save_chat_qa()` í•¨ìˆ˜ë¡œ ìˆ˜í–‰ë©ë‹ˆë‹¤.

---

### âš ï¸ ì˜ˆì™¸ ì²˜ë¦¬

* `doc_id`ê°€ ì—†ìœ¼ë©´ ì €ì¥ì„ ê±´ë„ˆëœë‹ˆë‹¤.
* MongoDB ì €ì¥ ë„ì¤‘ ì˜¤ë¥˜ ë°œìƒ ì‹œ ì½˜ì†”ì— ë¡œê·¸ ì¶œë ¥.

---

### ğŸ§ª ì‚¬ìš© ì˜ˆì‹œ

```python
from services.node.context.chat_history_node import load_context_node

state = {
  "doc_id": "doc_456",
  "question": "ë‚˜ ì´ ë¬¸ì„œì—ì„œ ë­ë¼ê³  ë¬¼ì–´ë´¤ì§€?"
}

updated_state = await load_context_node(state)
print(updated_state["context"])
```

---

### ğŸ“¦ ì‚¬ìš© ê¸°ìˆ 

| êµ¬ì„± ìš”ì†Œ                | ì„¤ëª…                     |
| -------------------- | ---------------------- |
| `ChatOpenAI`         | `gpt-4o-mini` ëª¨ë¸ ì‚¬ìš©    |
| `ChatPromptTemplate` | ì§ˆë¬¸-ì‘ë‹µ ê¸°ë¡ì„ ìš”ì•½í•˜ëŠ” í”„ë¡¬í”„íŠ¸ êµ¬ì„± |
| `MongoDB`            | ëŒ€í™” íˆìŠ¤í† ë¦¬ ì €ì¥ì†Œ            |
| `LangGraph`          | ë…¸ë“œ ì‹¤í–‰ íë¦„ ê´€ë¦¬            |
| `async/await`        | ë¹„ë™ê¸° ì²˜ë¦¬ ë°©ì‹ìœ¼ë¡œ ì‘ë‹µ ë° ì €ì¥ ìˆ˜í–‰ |

---

```