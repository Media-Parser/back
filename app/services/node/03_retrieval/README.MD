## ğŸ” Node: `balanced_retrieval_node.py`

ì‚¬ìš©ìì˜ ì§ˆë¬¸ì„ ë°”íƒ•ìœ¼ë¡œ **ì •ë‹¹ë³„ë¡œ ê· í˜• ì¡íŒ ë¬¸ì„œ ê²€ìƒ‰(balanced retrieval)**ì„ ìˆ˜í–‰í•˜ëŠ” LangGraph ë…¸ë“œì…ë‹ˆë‹¤.  
íŠ¹ì • ì •ë‹¹(ì˜ˆ: "ë”ë¶ˆì–´ë¯¼ì£¼ë‹¹", "êµ­ë¯¼ì˜í˜") ê°ê°ì— ëŒ€í•´ ë™ì¼í•œ ì¡°ê±´ìœ¼ë¡œ ë²¡í„° ê¸°ë°˜ ê²€ìƒ‰ì„ ì‹¤í–‰í•˜ê³ , ê²°ê³¼ë¥¼ ë‚˜ëˆ„ì–´ ì œê³µí•©ë‹ˆë‹¤.

---

### âœ… ì£¼ìš” ê¸°ëŠ¥

| í•­ëª© | ì„¤ëª… |
|------|------|
| ğŸ”„ ì •ë‹¹ë³„ ê²€ìƒ‰ | ê° ì •ë‹¹(party)ì— ëŒ€í•´ ê°œë³„ ê²€ìƒ‰ ìˆ˜í–‰ |
| ğŸ“… ë‚ ì§œ í•„í„° | `startdate` ~ `enddate` ë²”ìœ„ í•„í„° ì ìš© |
| ğŸ“° ë°ì´í„° íƒ€ì… í•„í„° | `"editorial"`, `"opinion"`, `"news"` ì¤‘ ì„ íƒì  í•„í„°ë§ |
| ğŸ’¡ ìœ ì‚¬ë„ ê²€ìƒ‰ | Chroma + OpenAI Embeddings ê¸°ë°˜ ë²¡í„° ê²€ìƒ‰ ìˆ˜í–‰ |
| ğŸ” ê²°ê³¼ ëˆ„ì  | ê° ì •ë‹¹ë³„ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ë¦¬ìŠ¤íŠ¸ë¡œ ëˆ„ì  í›„ ë°˜í™˜ |

---

### ğŸ§  ì‚¬ìš©ë˜ëŠ” ì…ë ¥ê°’ (`state["plan"]` ê¸°ë°˜)

| í•„ë“œ | ì„¤ëª… |
|------|------|
| `rewritten_question` | ê²€ìƒ‰ìš©ìœ¼ë¡œ ì¬ì‘ì„±ëœ ì§ˆë¬¸ |
| `parameters.k_per_side` | ì •ë‹¹ë‹¹ ê²€ìƒ‰í•  ë¬¸ì„œ ê°œìˆ˜ (ê¸°ë³¸ 2) |
| `filters.party` | ê²€ìƒ‰ ëŒ€ìƒ ì •ë‹¹ ë¦¬ìŠ¤íŠ¸ (ê¸°ë³¸ê°’: ["ë”ë¶ˆì–´ë¯¼ì£¼ë‹¹", "êµ­ë¯¼ì˜í˜"]) |
| `filters.startdate/enddate` | ë‚ ì§œ í•„í„° (`YYYY-MM-DD` í˜•ì‹) |
| `data_type` | ë¬¸ì„œ ìœ í˜• í•„í„° (`editorial`, `opinion`, `news`) |

---

### ğŸ“¦ ê¸°ìˆ  ìŠ¤íƒ

- **LangChain**: Chroma ë²¡í„°ìŠ¤í† ì–´ + OpenAI Embedding
- **Chroma**: `similarity_search_with_relevance_scores()`ë¡œ ìœ ì‚¬ë„ + í•„í„° ê¸°ë°˜ ê²€ìƒ‰
- **LangGraph**: ë…¸ë“œ ì‹¤í–‰ íë¦„ ê´€ë¦¬
- **í™˜ê²½ ë³€ìˆ˜**: `.env`ì—ì„œ OpenAI í‚¤ ë¡œë”©

---

### ğŸ§¾ ì¶œë ¥ ì˜ˆì‹œ (`state["documents_by_party"]`)

```json
[
  {
    "party": "ë”ë¶ˆì–´ë¯¼ì£¼ë‹¹",
    "documents": [
      {
        "page_content": "...",
        "metadata": { "date": "2024-03-10", "data_type": "opinion" }
      }
    ]
  },
  {
    "party": "êµ­ë¯¼ì˜í˜",
    "documents": [
      {
        "page_content": "...",
        "metadata": { "date": "2024-03-11", "data_type": "opinion" }
      }
    ]
  }
]
````

---

### âš ï¸ ì˜ˆì™¸ ì²˜ë¦¬

* ë‚ ì§œ íŒŒì‹± ì‹¤íŒ¨ ì‹œ ìë™ìœ¼ë¡œ ë¬´ì‹œ
* ë²¡í„°ìŠ¤í† ì–´ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ ì‹œ ì½˜ì†” ì¶œë ¥ (ê° ì •ë‹¹ë³„ë¡œ ë…ë¦½ì ìœ¼ë¡œ ìˆ˜í–‰ë˜ë¯€ë¡œ ì‹¤íŒ¨í•´ë„ ì „ì²´ëŠ” ê³„ì†ë¨)

---

### ğŸ” ë¡œê·¸ ì¶œë ¥ ì˜ˆì‹œ

```
--- ë…¸ë“œ ì‹¤í–‰: 2b. balanced_retrieval ---
ğŸ” [ì •ë‹¹: ë”ë¶ˆì–´ë¯¼ì£¼ë‹¹] ê²€ìƒ‰ í•„í„°: {'$and': [{'date_int': {'$gte': 20240701}}, {'party': {'$eq': 'ë”ë¶ˆì–´ë¯¼ì£¼ë‹¹'}}]}
âœ… ë”ë¶ˆì–´ë¯¼ì£¼ë‹¹: 2ê°œ ê²€ìƒ‰ë¨
ğŸ” [ì •ë‹¹: êµ­ë¯¼ì˜í˜] ê²€ìƒ‰ í•„í„°: {'$and': [{'date_int': {'$gte': 20240701}}, {'party': {'$eq': 'êµ­ë¯¼ì˜í˜'}}]}
âœ… êµ­ë¯¼ì˜í˜: 2ê°œ ê²€ìƒ‰ë¨
```

---

### ğŸ§ª ì‹¤í–‰ íë¦„ ì˜ˆì‹œ

```python
from nodes.balanced_retrieval_node import balanced_retrieval_node

state = {
  "plan": {
    "rewritten_question": "ì´ì„  ê³µì•½ ë¹„êµ",
    "filters": {
      "party": ["ë”ë¶ˆì–´ë¯¼ì£¼ë‹¹", "êµ­ë¯¼ì˜í˜"],
      "startdate": "2024-07-01",
      "enddate": "2024-07-25"
    },
    "parameters": { "k_per_side": 2 },
    "data_type": ["opinion"]
  }
}

new_state = balanced_retrieval_node(state)
print(new_state["documents_by_party"])
```


## ğŸ§  Node: `grade_and_filter_node.py`

ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ ë¬¸ì„œë¥¼ GPU ê¸°ë°˜ **Cross-Encoder ë¦¬ë­ì»¤**ë¡œ ì •ë°€í•˜ê²Œ í‰ê°€í•˜ê³ , **ì²­í¬ ë‹¨ìœ„ë¡œ í•„í„°ë§**í•˜ëŠ” ë…¸ë“œì…ë‹ˆë‹¤.  
ê²€ìƒ‰ ê²°ê³¼ì˜ í’ˆì§ˆì„ ë†’ì´ê³ , LLM ì‘ë‹µ ìƒì„± ë‹¨ê³„ì—ì„œ ìµœì ì˜ ë¬¸ì„œë¥¼ ì œê³µí•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.

---

### âœ… ì£¼ìš” ê¸°ëŠ¥ ìš”ì•½

| ë‹¨ê³„ | ì„¤ëª… |
|------|------|
| ğŸ“¥ ë¬¸ì„œ ì •ì œ | ê¸°ì¡´ ë¬¸ì„œ ë¦¬ìŠ¤íŠ¸ì—ì„œ ì ìˆ˜ ì œê±° (Tuple â†’ Document) |
| ğŸ“¦ ë¬¸ì„œ ì²­í‚¹ | 300ì ê¸°ì¤€ìœ¼ë¡œ ì²­í¬ë¡œ ë‚˜ëˆ” (ê²¹ì¹¨ 50ì) |
| ğŸ¯ GPU ë¦¬ë­í¬ | KoBGE ê¸°ë°˜ Cross-Encoderë¡œ ë¬¸ì„œ ì²­í¬ë¥¼ ì§ˆë¬¸ê³¼ ì •ë°€ ë¹„êµ |
| ğŸ”— ìš”ì•½ ìƒëµ ì‹œ ë§í¬ ëª©ë¡ ìƒì„± | ìš”ì•½ì´ í•„ìš” ì—†ëŠ” ê²½ìš°, ë¬¸ì„œ í•˜ì´í¼ë§í¬ë§Œ ì¶œë ¥ |
| ğŸ” ë¬¸ì„œ ì „ë‹¬ | ìƒì„±ì´ í•„ìš”í•œ ê²½ìš° Top ë¬¸ì„œë“¤ì„ ë‹¤ìŒ ë…¸ë“œë¡œ ì „ë‹¬ |

---

### ğŸ§  ì‚¬ìš© ëª¨ë¸

- ëª¨ë¸: [`Dongjin-kr/ko-reranker`](https://huggingface.co/Dongjin-kr/ko-reranker)  
- êµ¬ì¡°: BERT ê¸°ë°˜ Cross-Encoder
- ì‹¤í–‰: `transformers` + `torch` ì‚¬ìš© (GPU ë˜ëŠ” CPU)

```python
tokenizer = AutoTokenizer.from_pretrained(MODEL_PATH)
model = AutoModelForSequenceClassification.from_pretrained(MODEL_PATH).to(device)
````

---

### âš™ï¸ ì…ë ¥/ì¶œë ¥ ì˜ˆì‹œ

#### ğŸ“¥ ì…ë ¥ (`state`)

```json
{
  "question": "ì´ì„ ì—ì„œ ê° ë‹¹ì˜ ì…ì¥ì€ ì–´ë–»ê²Œ ë‹¤ë¥¸ê°€ìš”?",
  "documents": [Document(page_content="...", metadata={"title": "ë¯¼ì£¼ë‹¹ ì…ì¥", ...})],
  "plan": {
    "generation_required": false
  }
}
```

#### ğŸ“¤ ì¶œë ¥ (`state`)

```json
{
  "documents": [...Top 5 ë¬¸ì„œ ì²­í¬...],
  "generation": "- [ë¯¼ì£¼ë‹¹ ì…ì¥](https://example.com/1)\n- [êµ­ë¯¼ì˜í˜ ì…ì¥](https://example.com/2)"
}
```

> `generation_required: false`ì¸ ê²½ìš° `generation` í•„ë“œì— ë§í¬ ìš”ì•½ ë°˜í™˜
> ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ë¬¸ì„œë§Œ ë‹¤ìŒ ë…¸ë“œë¡œ ì „ë‹¬ë¨

---

### ğŸ“Š ë¡œê·¸ ì˜ˆì‹œ

```
--- ë…¸ë“œ ì‹¤í–‰: 3. grade_and_filter (GPU ë¦¬ë­ì»¤ + ì²­í‚¹) ---
ğŸ“¥ ì´ 12ê°œ ë¬¸ì„œ ë¦¬ë­í‚¹ ì¤‘...
âœ… 1ìœ„ ë¬¸ì„œ (score=0.4721): êµ­ë¯¼ì˜í˜ì€ ë³µì§€ ì¬ì› í™•ë³´ë¥¼ ìœ„í•´...
ğŸ¯ ìµœì¢… ì„ íƒ ë¬¸ì„œ ì¡°ê° ìˆ˜: 5
```

---

### ğŸ“¦ êµ¬ì„± ìš”ì†Œë³„ ê¸°ìˆ  ìŠ¤íƒ

| êµ¬ì„± ìš”ì†Œ      | ë¼ì´ë¸ŒëŸ¬ë¦¬                                        |
| ---------- | -------------------------------------------- |
| ë¬¸ì„œ ì²­í‚¹      | `RecursiveCharacterTextSplitter` (LangChain) |
| ë¦¬ë­ì»¤ ëª¨ë¸     | `transformers` + `torch`                     |
| ë²¡í„° ì •ê·œí™”     | `exp_normalize()` ê¸°ë°˜ softmax                 |
| ë©€í‹° ë””ë°”ì´ìŠ¤ ì§€ì› | CUDA / CPU ìë™ ì„ íƒ                             |
| ë¬¸ì„œ ìš”ì•½ ëŒ€ì²´   | Markdown ë§í¬ í…ìŠ¤íŠ¸ë¡œ ì¶œë ¥                          |

---

### ğŸ§ª ì‚¬ìš© ì˜ˆì‹œ (ì§ì ‘ í˜¸ì¶œ)

```python
from services.node.03_retrieval.grade_and_filter_node import grade_and_filter_node

state = {
  "question": "ì´ì„  ê³µì•½ ì°¨ì´ë¥¼ ë¹„êµí•´ì¤˜",
  "documents": [...],  # Document ë¦¬ìŠ¤íŠ¸
  "plan": { "generation_required": False }
}

result = grade_and_filter_node(state)
print(result["generation"])  # â†’ ë¬¸ì„œ ë§í¬ ë¦¬ìŠ¤íŠ¸ ë˜ëŠ” ë‹¤ìŒ ë…¸ë“œë¡œ ì „ë‹¬
```


ì•„ë˜ëŠ” `standard_retrieval_node.py`ë¥¼ ì„¤ëª…í•˜ëŠ” GitHub `README.md`ìš© **ë§ˆí¬ë‹¤ìš´ ë¬¸ì„œ**ì…ë‹ˆë‹¤. ì´ ë…¸ë“œëŠ” **ê¸°ë³¸ ìœ ì‚¬ë„ ê¸°ë°˜ ë¬¸ì„œ ê²€ìƒ‰ ê¸°ëŠ¥**ì„ ìˆ˜í–‰í•˜ëŠ” LangGraph ë…¸ë“œë¡œ, ë‚ ì§œ/ì£¼ì œ í•„í„°ì™€ í•¨ê»˜ Chroma DBë¥¼ ìˆœíšŒí•˜ë©° ë¬¸ì„œë¥¼ ê²€ìƒ‰í•˜ëŠ” êµ¬ì¡°ì…ë‹ˆë‹¤.




## ğŸ“„ Node: `standard_retrieval_node.py`

ì´ ë…¸ë“œëŠ” ì‚¬ìš©ìì˜ ì§ˆë¬¸ì„ ê¸°ë°˜ìœ¼ë¡œ, ì„¤ì •ëœ ë©”íƒ€ë°ì´í„° í•„í„°(ë‚ ì§œ, ì£¼ì œ ë“±)ë¥¼ ì ìš©í•˜ì—¬ **Chroma ë²¡í„° ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ìœ ì‚¬ ë¬¸ì„œë¥¼ ê²€ìƒ‰**í•˜ëŠ” ê¸°ëŠ¥ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

---

### âœ… ì£¼ìš” ê¸°ëŠ¥ ìš”ì•½

| í•­ëª© | ì„¤ëª… |
|------|------|
| ğŸ” ì¬ì‘ì„± ì§ˆë¬¸ ê¸°ë°˜ ê²€ìƒ‰ | `plan.rewritten_question` ê¸°ì¤€ ìœ ì‚¬ë„ ê²€ìƒ‰ ìˆ˜í–‰ |
| ğŸ“… ë‚ ì§œ í•„í„° ì§€ì› | `startdate`, `enddate` â†’ `date_int`ë¡œ ë³€í™˜ |
| ğŸ§  í† í”½ í•„í„° ì§€ì› | íŠ¹ì • ì£¼ì œ IDë¡œ í•„í„°ë§ (`topic_id`) |
| ğŸ—‚ï¸ ë°ì´í„° íƒ€ì…ë³„ ê²€ìƒ‰ | `"opinion"`, `"editorial"` ë“± ìœ í˜•ë³„ DBì—ì„œ ê²€ìƒ‰ |
| ğŸ“Š ìœ ì‚¬ë„ ì ìˆ˜ í¬í•¨ | `similarity_search_with_relevance_scores()` ì‚¬ìš© |
| ğŸ¯ ìµœì¢… ë¬¸ì„œ ì •ë ¬ | ì ìˆ˜ ê¸°ì¤€ ì •ë ¬ í›„ ìƒìœ„ `k`ê°œ ì¶”ì¶œ |

---

### ğŸ§  ì…ë ¥ (`state`)

```json
{
  "plan": {
    "rewritten_question": "ì´ì„  ê³µì•½ ë¹„êµ",
    "parameters": { "k": 10 },
    "filters": {
      "startdate": "2024-06-01",
      "enddate": "2024-07-25",
      "topic_id": "election"
    },
    "data_type": ["opinion", "editorial"]
  }
}
````

---

### ğŸ“¤ ì¶œë ¥ (`state["documents"]`)

ìµœì¢… ì„ íƒëœ ë¬¸ì„œ ë¦¬ìŠ¤íŠ¸ (LangChain `Document` ê°ì²´ ë°°ì—´).
ì˜ˆì‹œ:

```json
[
  {
    "page_content": "...ì´ì„  ê³µì•½ì— ëŒ€í•œ ë”ë¶ˆì–´ë¯¼ì£¼ë‹¹ì˜ ì…ì¥...",
    "metadata": {
      "date": "2024-07-01",
      "topic_id": "election",
      "data_type": "opinion"
    }
  },
  ...
]
```

---

### ğŸ” ë¡œê·¸ ì¶œë ¥ ì˜ˆì‹œ

```
--- ë…¸ë“œ ì‹¤í–‰: standard_retrieval (ìœ ì‚¬ë„ ì ìˆ˜ í¬í•¨) ---
ğŸ” ê²€ìƒ‰ í•„í„°: {'$and': [{'date_int': {'$gte': 20240601}}, {'date_int': {'$lte': 20240725}}, {'topic_id': {'$eq': 'election'}}]}
ğŸ“ ê²€ìƒ‰ ëŒ€ìƒ DB: chroma_db_opinion
ğŸ“ ê²€ìƒ‰ ëŒ€ìƒ DB: chroma_db_editorial
ğŸ“¦ ìµœì¢… ë¬¸ì„œ ê°œìˆ˜: 6

ğŸ“„ ë¬¸ì„œ 1 (score: 0.7621)
ë‚´ìš©: ë”ë¶ˆì–´ë¯¼ì£¼ë‹¹ì€ ì´ë²ˆ ì´ì„ ì—ì„œ ë³µì§€ ì¬ì • í™•ëŒ€ë¥¼ ì£¼ìš” ê³µì•½ìœ¼ë¡œ ë‚´ì„¸ì› ë‹¤...
ë©”íƒ€ë°ì´í„°: {'date': '2024-07-01', 'data_type': 'opinion', ...}
```

---

### ğŸ“¦ ê¸°ìˆ  ìŠ¤íƒ

| êµ¬ì„± ìš”ì†Œ              | ì„¤ëª…                                |
| ------------------ | --------------------------------- |
| `Chroma`           | ìœ ì‚¬ë„ ê¸°ë°˜ ë²¡í„° ê²€ìƒ‰                      |
| `OpenAIEmbeddings` | ë¬¸ì¥ ì„ë² ë”© ìƒì„±                         |
| `date_to_int`      | `"YYYY-MM-DD"` â†’ `YYYYMMDD` ì •ìˆ˜ ë³€í™˜ |
| `GraphState`       | LangGraph íë¦„ ìƒíƒœ ê°ì²´                |

---

### âš ï¸ ì˜ˆì™¸ ì²˜ë¦¬

* ë‚ ì§œë‚˜ í•„í„°ê°’ ëˆ„ë½ ì‹œ í•´ë‹¹ ì¡°ê±´ ìƒëµ
* ê° ë°ì´í„° íƒ€ì…ë³„ DB ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ ì‹œ ê°œë³„ ì¶œë ¥ (ì „ì²´ ì¤‘ë‹¨ ì—†ìŒ)

---

### ğŸ§ª ì‹¤í–‰ ì˜ˆì‹œ

```python
from services.node.03_retrieval.standard_retrieval_node import standard_retrieval_node

state = {
  "plan": {
    "rewritten_question": "í›„ë³´ì ê³µì•½ ë¹„êµ",
    "filters": {
      "startdate": "2024-06-01",
      "enddate": "2024-07-01",
      "topic_id": "ì´ì„ "
    },
    "parameters": { "k": 5 },
    "data_type": ["opinion"]
  }
}

updated_state = standard_retrieval_node(state)
print(updated_state["documents"][0].page_content[:200])
```